{% extends "_layout.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card p-4">
      <h5>Nuovo utente</h5>
      <form method="post">
        <div class="mb-2">
          <label class="form-label">Username</label>
          <input class="form-control" name="username" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Password</label>
          <input class="form-control" name="password" type="password" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Nome completo</label>
          <input class="form-control" name="full_name">
        </div>
        <div class="mb-3">
          <label class="form-label">Ruolo</label>
          <select class="form-select" name="role">
            <option value="capo">Capocantiere</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button class="btn btn-primary">Crea utente</button>
      </form>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card p-4">
      <h5>Utenti</h5>
      <table class="table align-middle">
        <thead><tr><th>Username</th><th>Nome</th><th>Ruolo</th><th class="text-end">Azioni</th></tr></thead>
        <tbody>
        {% for u in users %}
          <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.full_name or "-" }}</td>
            <td><span class="badge {{ 'bg-primary' if u.role=='admin' else 'bg-secondary' }}">{{ u.role }}</span></td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_user', uid=u.id) }}" class="d-inline-flex gap-2">
                <input type="hidden" name="username" value="{{ u.username }}">
                <input type="hidden" name="full_name" value="{{ u.full_name or '' }}">
                <input type="hidden" name="role" value="{{ u.role }}">
                <input type="password" name="password" class="form-control form-control-sm" placeholder="nuova password">
                <button class="btn btn-sm btn-outline-primary">Aggiorna</button>
              </form>
              {% if current_user.id != u.id %}
              <form method="post" class="d-inline" action="{{ url_for('delete_user', uid=u.id) }}"
                    onsubmit="return confirm('Eliminare utente?')">
                <button class="btn btn-sm btn-outline-danger">Elimina</button>
              </form>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="4" class="text-muted">Nessun utente</td></tr>
        {% endfor %}
        </tbody>
      </table>

      <hr>
      <h6>Assegna cantiere a utente</h6>
      <form method="post" action="{{ url_for('assign_site') }}" class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Utente</label>
          <select class="form-select" name="user_id" required>
            <option value="">—</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cantiere</label>
          <select class="form-select" name="site_id" required>
            <option value="">—</option>
            {% for s in sites %}
              <option value="{{ s.id }}">{{ s.name }} — {{ s.client.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Inizio</label>
          <input type="date" class="form-control" name="start_date">
        </div>
        <div class="col-md-2">
          <label class="form-label">Fine</label>
          <input type="date" class="form-control" name="end_date">
        </div>
        <div class="col-12">
          <button class="btn btn-primary">Assegna</button>
        </div>
      </form>

      <h6 class="mt-3">Assegnazioni</h6>
      <ul class="mb-0">
        {% for a in assignments %}
          <li>
            {{ a.user.username }} → <strong>{{ a.site.name }}</strong>
            {% if a.start_date or a.end_date %}
              <span class="text-muted"> ({{ a.start_date or '-' }} - {{ a.end_date or '-' }})</span>
            {% endif %}
            <form method="post" action="{{ url_for('delete_assignment', aid=a.id) }}" class="d-inline"
                  onsubmit="return confirm('Rimuovere assegnazione?')">
              <button class="btn btn-sm btn-outline-danger">Rimuovi</button>
            </form>
          </li>
        {% else %}
          <li class="text-muted">Nessuna assegnazione</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
