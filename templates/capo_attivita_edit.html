{% extends "_layout.html" %}
{% block title %}Modifica attività #{{ entry.id }}{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Modifica attività</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('capo_attivita') }}">← Torna all’elenco</a>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="text-muted small">Data</div>
          <div class="fw-semibold">{{ entry.work_date.strftime("%Y-%m-%d") }}</div>
        </div>
        <div class="col-12 col-md-5">
          <div class="text-muted small">Cantiere</div>
          <div class="fw-semibold">
            {{ entry.site.name if entry.site else "-" }}
            {% if entry.site and entry.site.client %}
              <span class="text-muted">— {{ entry.site.client.name }}</span>
            {% endif %}
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="text-muted small">Attività</div>
          <div class="fw-semibold">
            {% if entry.client_activity and entry.client_activity.activity %}
              {{ entry.client_activity.activity.code }} — {{ entry.client_activity.activity.description }}
              <span class="text-muted">(UM: {{ entry.client_activity.activity.unit }})</span>
            {% else %}-{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ===== FORM MODIFICA QTY/NOTE + MULTI-FOTO ===== #}
  <div class="card">
    <div class="card-body">
      <form method="post" action="{{ url_for('capo_attivita_edit', eid=entry.id) }}" enctype="multipart/form-data" id="form-edit">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label class="form-label">Quantità</label>
            <input type="number" step="0.01" class="form-control" name="qty" value="{{ entry.qty or 0 }}">
          </div>
          <div class="col-12 col-md-9">
            <label class="form-label">Note</label>
            <input type="text" class="form-control" name="note" value="{{ entry.note or '' }}" placeholder="Facoltative">
          </div>

          <div class="col-12">
            <label class="form-label">Aggiungi foto (puoi selezionare più file)</label>
            <input type="file" class="form-control" name="photos" id="photos" multiple accept=".jpg,.jpeg,.png,.gif,.webp,.pdf">
            <div id="previews" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary">Salva modifiche</button>
          <a class="btn btn-light" href="{{ url_for('capo_attivita') }}">Annulla</a>
        </div>
      </form>
    </div>
  </div>

  {# ===== GALLERIA FOTO ESISTENTI ===== #}
  <div class="card mt-4">
    <div class="card-body">
      <h5 class="mb-3">Foto allegate</h5>

      <div class="row g-3">
        {# foto principale dell'entry #}
        {% if entry.photo_path %}
          {% set ph = entry.photo_path %}
          {% set href = (url_for('static', filename=ph) if ph and not ph.startswith('http') and not ph.startswith('/') else ph) %}
          <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2 h-100">
              <a href="{{ href }}" target="_blank" class="d-block mb-2">
                <img src="{{ href }}" alt="foto principale"
                     style="width:100%;height:180px;object-fit:cover;border-radius:8px;">
              </a>
              <div class="small text-muted">Foto principale</div>
            </div>
          </div>
        {% endif %}

        {# foto aggiuntive (ActivityEntryPhoto) #}
        {% for p in photos %}
          {% set path = p.path %}
          {% set href2 = (url_for('static', filename=path) if path and not path.startswith('http') and not path.startswith('/') else path) %}
          <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2 h-100 d-flex flex-column">
              <a href="{{ href2 }}" target="_blank" class="d-block mb-2">
                <img src="{{ href2 }}" alt="foto"
                     style="width:100%;height:180px;object-fit:cover;border-radius:8px;">
              </a>
              <form method="post" action="{{ url_for('capo_attivita_photo_delete', pid=p.id) }}"
                    onsubmit="return confirm('Eliminare questa foto?');" class="mt-auto">
                <button class="btn btn-sm btn-outline-danger w-100">Elimina foto</button>
              </form>
              <div class="small text-muted mt-2">
                Caricata: {{ p.uploaded_at.strftime("%Y-%m-%d %H:%M") if p.uploaded_at else "-" }}
              </div>
            </div>
          </div>
        {% endfor %}

        {% if not entry.photo_path and (not photos or photos|length == 0) %}
          <div class="col-12 text-muted">Nessuna foto allegata.</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

{# ===== JS PREVIEW MULTI-FOTO ===== #}
<script>
(function() {
  const input = document.getElementById('photos');
  const box = document.getElementById('previews');

  if (!input || !box) return;

  input.addEventListener('change', function() {
    box.innerHTML = '';
    const files = Array.from(this.files || []);
    files.forEach(f => {
      const ext = (f.name.split('.').pop() || '').toLowerCase();
      const wrap = document.createElement('div');
      wrap.style.width = '120px';
      wrap.style.height = '120px';
      wrap.style.borderRadius = '8px';
      wrap.style.border = '1px solid #e4e4e4';
      wrap.style.overflow = 'hidden';

      if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
        const img = document.createElement('img');
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.src = URL.createObjectURL(f);
        wrap.appendChild(img);
      } else {
        const cap = document.createElement('div');
        cap.style.fontSize = '12px';
        cap.style.padding = '6px';
        cap.textContent = f.name;
        wrap.appendChild(cap);
      }
      box.appendChild(wrap);
    });
  });
})();
</script>
{% endblock %}
