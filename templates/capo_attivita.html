{% extends "_layout.html" %}
{% block title %}Registra attività{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Registra attività</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">← Dashboard</a>
  </div>

  {# ====== FORM INSERIMENTO ====== #}
  <div class="card mb-4">
    <div class="card-body">
      <form method="post" action="{{ url_for('capo_attivita') }}" enctype="multipart/form-data" id="form-attivita">
        <div class="row g-3">

          <div class="col-12 col-md-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" name="work_date" value="{{ date.today().isoformat() }}">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Cantiere</label>
            <select class="form-select" name="site_id" id="site_id" required>
              <option value="">— Seleziona —</option>
              {# dedup siti da assignments #}
              {% set seen = [] %}
              {% for a in assignments %}
                {% if a.site and a.site.id not in seen %}
                  <option value="{{ a.site.id }}">{{ a.site.name }}{% if a.site.client %} — {{ a.site.client.name }}{% endif %}</option>
                  {% set _ = seen.append(a.site.id) %}
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-5">
            <label class="form-label">Attività</label>
            <select class="form-select" name="client_activity_id" id="client_activity_id" required>
              <option value="">— Seleziona prima un cantiere —</option>
              {% for ca in assigned_ca %}
                {% if ca.activity %}
                  <option
                    value="{{ ca.id }}"
                    data-site="{{ ca.site_id }}"
                  >
                    {{ ca.activity.code }} — {{ ca.activity.description }}
                    (UM: {{ ca.activity.unit }})
                  </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Quantità</label>
            <input type="number" step="0.01" class="form-control" name="qty" value="0" required>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Note</label>
            <input type="text" class="form-control" name="note" placeholder="Facoltative">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Foto (opzionale)</label>
            <input type="file" class="form-control" name="photo" accept=".jpg,.jpeg,.png,.gif,.webp,.pdf">
          </div>

        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary">Salva</button>
          <button type="reset" class="btn btn-light">Reset</button>
        </div>
      </form>
    </div>
  </div>

  {# ====== ELENCO ULTIME ATTIVITÀ ====== #}
  <div class="card">
    <div class="card-body">
      <h5 class="mb-3">Ultime attività</h5>

      {% if entries|length == 0 %}
        <div class="text-muted">Non ci sono attività registrate.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Cantiere</th>
                <th>Attività</th>
                <th class="text-end">Q.tà</th>
                <th>Note</th>
                <th>Foto</th>
                <th class="text-end">Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
                <tr>
                  <td>{{ e.work_date.strftime("%Y-%m-%d") }}</td>
                  <td>
                    {{ e.site.name if e.site else '-' }}
                    {% if e.site and e.site.client %}<div class="text-muted small">{{ e.site.client.name }}</div>{% endif %}
                  </td>
                  <td>
                    {% if e.client_activity and e.client_activity.activity %}
                      <div class="fw-semibold">{{ e.client_activity.activity.code }}</div>
                      <div class="text-muted small">{{ e.client_activity.activity.description }}</div>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="text-end">{{ "%.2f"|format(e.qty or 0) }}</td>
                  <td>{{ e.note or "" }}</td>
                  <td style="max-width:260px;">
                    <div class="d-flex flex-wrap gap-2">
                      {# foto principale caricata al momento dell'inserimento #}
                      {% if e.photo_path %}
                        {% set ph = e.photo_path %}
                        {% set href = (url_for('static', filename=ph) if ph and not ph.startswith('http') and not ph.startswith('/') else ph) %}
                        <a href="{{ href }}" target="_blank" title="Foto">
                          <img src="{{ href }}" alt="foto"
                               style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e4e4e4;">
                        </a>
                      {% endif %}

                      {# multi-foto aggiuntive da ActivityEntryPhoto #}
                      {% if entry_photos and entry_photos.get(e.id) %}
                        {% for p in entry_photos[e.id][:4] %}
                          {% set path = p.path %}
                          {% set href2 = (url_for('static', filename=path) if path and not path.startswith('http') and not path.startswith('/') else path) %}
                          <a href="{{ href2 }}" target="_blank" title="foto {{ loop.index }}">
                            <img src="{{ href2 }}" alt="foto"
                                 style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e4e4e4;">
                          </a>
                        {% endfor %}
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="btn-group">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('capo_attivita_edit', eid=e.id) }}">Modifica</a>
                      <form method="post" action="{{ url_for('delete_entry', eid=e.id) }}" onsubmit="return confirm('Eliminare questa attività?');">
                        <button class="btn btn-sm btn-outline-danger">Elimina</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{# ====== JS: filtro Attività in base al Cantiere ====== #}
<script>
(function(){
  const siteSel = document.getElementById('site_id');
  const caSel   = document.getElementById('client_activity_id');
  const allOpts = Array.from(caSel.querySelectorAll('option[value]'));

  function filterActivities() {
    const sid = siteSel.value;
    caSel.value = '';
    // se non selezionato cantiere => mostra placeholder e nascondi tutto
    if (!sid) {
      caSel.innerHTML = '<option value="">— Seleziona prima un cantiere —</option>';
      return;
    }
    const frag = document.createDocumentFragment();
    let count = 0;
    allOpts.forEach(opt => {
      if (opt.dataset.site === sid) {
        frag.appendChild(opt.cloneNode(true));
        count++;
      }
    });
    caSel.innerHTML = '';
    if (!count) {
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '— Nessuna attività associata a questo cantiere —';
      caSel.appendChild(empty);
    } else {
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = '— Seleziona —';
      caSel.appendChild(ph);
      caSel.appendChild(frag);
    }
  }

  siteSel && siteSel.addEventListener('change', filterActivities);
})();
</script>
{% endblock %}
