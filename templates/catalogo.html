{% extends "_layout.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Catalogo attività</h2>

  <!-- Inserisci nuova attività -->
  <form method="post" class="row g-2 mb-4">
    <div class="col-md-2">
      <label class="form-label">Codice</label>
      <input type="text" class="form-control" name="code" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Descrizione</label>
      <input type="text" class="form-control" name="description" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Unità</label>
      <input type="text" class="form-control" name="unit" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Prezzo Unitario (€)</label>
      <input type="number" step="0.01" class="form-control" name="unit_price" required>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-success w-100">Aggiungi</button>
    </div>
  </form>

  <!-- Elenco attività -->
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Codice</th>
        <th>Descrizione</th>
        <th>UM</th>
        <th>Prezzo Unit.</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td>{{ it.code }}</td>
        <td>{{ it.description }}</td>
        <td>{{ it.unit }}</td>
        <td>{{ "%.2f"|format(it.unit_price) }}</td>
        <td>
          <form method="post" action="{{ url_for('delete_catalogo', aid=it.id) }}" onsubmit="return confirm('Eliminare attività?')">
            <button class="btn btn-sm btn-danger">Elimina</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5" class="text-center">Nessuna attività presente</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Assegna attività a cantiere -->
  <h4 class="mt-4">Assegna attività a cantiere</h4>

  {% if not sites %}
    <div class="alert alert-warning">
      Nessun cantiere disponibile. Vai su 
      <a href="{{ url_for('clients_sites') }}">Clienti & Cantieri</a> per crearli.
    </div>
  {% else %}
    <form method="post" action="{{ url_for('assign_activity') }}" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Cantiere</label>
        <select class="form-select" name="site_id" required>
          <option value="">—</option>
          {% for s in sites %}
            <option value="{{ s.id }}">
              {{ s.name }}{% if s.client %} — {{ s.client.name }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Attività</label>
        <select class="form-select" name="activity_id" required>
          <option value="">—</option>
          {% for it in items %}
            <option value="{{ it.id }}">{{ it.code }} — {{ it.description }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Q.tà iniziale</label>
        <input type="number" step="0.01" class="form-control" name="initial_qty" value="0">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100">Assegna</button>
      </div>
    </form>
  {% endif %}
</div>
{% endblock %}
